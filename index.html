<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Integrador Homolog Solar</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; background-color: #f8f9fa; margin: 20px; }
        .container { background: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 500px; box-sizing: border-box; margin-bottom: 20px;}
        h2 { text-align: center; color: #212529; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #ff9900; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        #message { margin-top: 20px; padding: 12px; border-radius: 6px; text-align: center; display: none; }
        .success { background-color: #d1e7dd; color: #0f5132; display: block; }
        .error { background-color: #f8d7da; color: #842029; display: block; }
        #integradores-lista { list-style-type: none; padding: 0; }
        #integradores-lista li { background: #f1f3f5; padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #ff9900; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Cadastro de Novo Integrador</h2>
        <form id="integradorForm">
            <div class="form-group">
                <label for="nome_do_integrador">Nome Completo:</label>
                <input type="text" id="nome_do_integrador" required>
            </div>
            <div class="form-group">
                <label for="numero_de_contato">Telefone (apenas números):</label>
                <input type="text" id="numero_de_contato" inputmode="tel" required>
            </div>
            <button type="submit" id="submitButton">Cadastrar Integrador</button>
            <div id="message"></div>
        </form>
    </div>

    <div class="container">
        <h2>Integradores Cadastrados</h2>
        <ul id="integradores-lista">
            </ul>
    </div>

    <script>
        const form = document.getElementById('integradorForm');
        const submitButton = document.getElementById('submitButton');
        const messageDiv = document.getElementById('message');
        const listaUl = document.getElementById('integradores-lista');

        const API_URL_CREATE = 'api/integrador.php';
        const API_URL_LIST = 'api/listar_integradores.php';
        const API_URL_DELETE = 'api/delete_integrador.php'; 

        async function deleteIntegrador(id) {
            if (!confirm('Tem certeza que deseja deletar este integrador?')) return;
            try {
                const response = await fetch(`${API_URL_DELETE}?id=${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) { throw new Error(result.message); }
                alert('Integrador deletado com sucesso!');
                fetchIntegradores(); // Atualiza a lista após a deleção
            } catch (error) {
                alert(`Erro ao deletar integrador: ${error.message}`);
            }
        }

        async function fetchIntegradores() {
            listaUl.innerHTML = '<li>Carregando...</li>';
            try {
                const response = await fetch(API_URL_LIST);
                if (!response.ok) {
                    throw new Error('Falha ao carregar a lista de integradores.');
                }
                const integradores = await response.json();

                listaUl.innerHTML = ''; // Limpa a lista
                
                // Verifica se a resposta é um array e não está vazio
                if (Array.isArray(integradores) && integradores.length > 0) {
                    integradores.forEach(integrador => {
                        const li = document.createElement('li');
                        li.textContent = `${integrador.nome_do_integrador} - ${integrador.numero_de_contato}`;
                        li.className = 'integrador-item';
                        li.style.cursor = 'pointer';
                        li.onclick = (e) => {
                            // Evita que o clique no botão delete acione o evento do li
                            if (e.target.tagName.toLowerCase() === 'button') return;
                            // Abre a página do integrador (ajuste a URL conforme necessário)
                            const url = `/integrador.html?id=${integrador.id}`;
                            window.open(url, '_blank');
                        };
                        // Adiciona botão de deletar
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Deletar';
                        deleteButton.style.marginLeft = '10px';
                        deleteButton.onclick = (e) => {
                            e.stopPropagation(); // Impede o clique de propagar para o li
                            deleteIntegrador(integrador.id);
                        };
                        li.appendChild(deleteButton);
                        listaUl.appendChild(li);
                    });
                } else {
                    listaUl.innerHTML = '<li>Nenhum integrador cadastrado.</li>';
                }
            } catch (error) {
                console.error('Erro ao buscar integradores:', error);
                listaUl.innerHTML = `<li style="border-color: #842029; color: #842029;">${error.message}</li>`;
            }
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            messageDiv.className = '';

            const data = {
                nome_do_integrador: document.getElementById('nome_do_integrador').value,
                numero_de_contato: document.getElementById('numero_de_contato').value
            };

            try {
                const response = await fetch(API_URL_CREATE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (!response.ok) { throw new Error(result.message); }

                messageDiv.textContent = `Sucesso! ID: ${result.id}.`;
                messageDiv.className = 'success';
                form.reset();
                fetchIntegradores(); // Atualiza a lista após o sucesso

            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'error';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Cadastrar Integrador';
            }
        });

        // Carrega a lista de integradores quando a página é aberta
        document.addEventListener('DOMContentLoaded', fetchIntegradores);
    </script>

</body>
</html>